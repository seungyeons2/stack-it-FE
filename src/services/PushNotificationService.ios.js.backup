// src/services/PushNotificationService.ios.js
import { Platform } from "react-native";
import * as Device from "expo-device";
import * as Notifications from "expo-notifications";
import Constants from "expo-constants";
import messaging from '@react-native-firebase/messaging';

export function setupNotificationListeners() {
  const recvSub = Notifications.addNotificationReceivedListener((n) => {
    try { console.log("[Push][recv]:", JSON.stringify(n, null, 2)); }
    catch { console.log("[Push][recv]"); }
  });
  const respSub = Notifications.addNotificationResponseReceivedListener((r) => {
    try { console.log("[Push][tap]:", JSON.stringify(r, null, 2)); }
    catch { console.log("[Push][tap]"); }
  });
  return () => {
    try {
      Notifications.removeNotificationSubscription(recvSub);
      Notifications.removeNotificationSubscription(respSub);
    } catch {}
  };
}

// FCM í† í°ì„ Expo Push Tokenìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
export async function convertFCMToExpoPushToken() {
  try {
    if (Platform.OS !== "ios") {
      throw new Error("iOS only");
    }
    
    if (!Device.isDevice) {
      throw new Error("ì‹¤ê¸°ê¸° í•„ìš”");
    }

    // FCM í† í° ê°€ì ¸ì˜¤ê¸°
    const fcmToken = await messaging().getToken();
    console.log("ðŸ”¥ [FCM] FCM Token íšë“:", fcmToken);

    // projectId í™•ì¸
    const projectId =
      (Constants.easConfig && Constants.easConfig.projectId) ||
      (Constants.expoConfig &&
        Constants.expoConfig.extra &&
        Constants.expoConfig.extra.eas &&
        Constants.expoConfig.extra.eas.projectId);

    if (!projectId) {
      throw new Error("EAS projectId ì—†ìŒ");
    }

    // FCM í† í°ì„ Expo Push Tokenìœ¼ë¡œ ë³€í™˜
    // ExpoëŠ” FCM í† í°ì„ ìžë™ìœ¼ë¡œ Expo Push Token í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤
    const expoPushToken = `ExponentPushToken[${fcmToken}]`;
    
    console.log("ðŸ“¢ [Push] FCM â†’ Expo Push Token ë³€í™˜ ì™„ë£Œ:", expoPushToken);
    
    return {
      success: true,
      fcmToken: fcmToken,
      expoPushToken: expoPushToken
    };
  } catch (error) {
    const msg = error?.message || String(error);
    console.error("âŒ [Push] FCM â†’ Expo Push Token ë³€í™˜ ì‹¤íŒ¨:", msg);
    return {
      success: false,
      error: msg
    };
  }
}

// âœ… await í•œ ì¤„ë„ ì—†ìŒ. Expo í† í° "ë°œê¸‰ & ë¡œê·¸ë§Œ" ì°ê³  ë.
export function registerExpoPushToken(/* navigation? */) {
  return new Promise((resolve) => {
    try {
      if (Platform.OS !== "ios") {
        return resolve({ success: false, error: "iOS only (.ios.js)" });
      }
      if (!Device.isDevice) {
        return resolve({ success: false, error: "ì‹¤ê¸°ê¸° í•„ìš”" });
      }

      // 1) ê¶Œí•œ í™•ì¸
      Notifications.getPermissionsAsync()
        .then((perm) => {
          const existing = perm?.status;
          console.log("[Push] permissions(existing):", existing, perm);

          if (existing === "granted") return "granted";
          // ê¶Œí•œ ìš”ì²­
          return Notifications.requestPermissionsAsync({
            ios: { allowAlert: true, allowBadge: true, allowSound: true },
          }).then((r) => r?.status || "undetermined");
        })
        .then((finalStatus) => {
          console.log("[Push] permission:", finalStatus);
          if (finalStatus !== "granted") {
            throw new Error("ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨");
          }

          // 2) FCM í† í°ì„ Expo Push Tokenìœ¼ë¡œ ë³€í™˜
          return convertFCMToExpoPushToken();
        })
        .then((result) => {
          if (result.success) {
            console.log("ðŸ“¢ [Push] ExpoPushToken ë°œê¸‰ë¨:", result.expoPushToken);
            resolve({ 
              success: true, 
              expoPushToken: result.expoPushToken,
              fcmToken: result.fcmToken
            });
          } else {
            throw new Error(result.error);
          }
        })
        .catch((err) => {
          const msg = err?.message || String(err);
          console.warn("[Push][ERR] registerExpoPushToken:", msg);
          resolve({ success: false, error: msg });
        });
    } catch (e) {
      const msg = e?.message || String(e);
      console.warn("[Push][ERR] registerExpoPushToken(sync):", msg);
      resolve({ success: false, error: msg });
    }
  });
}
